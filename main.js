(()=>{"use strict";function e(e){"Escape"===e.key&&n(document.querySelector(".pop-up_opened"))}function t(t){t.classList.add("pop-up_opened"),document.addEventListener("keydown",e)}function n(t){document.removeEventListener("keydown",e),t.classList.remove("pop-up_opened")}function o(e){var t=e.template.content.cloneNode(!0);t.querySelector(e.elementNameSelector).textContent=e.newImgName;var n=t.querySelector(e.elementPhotoSelector);return n.setAttribute("src",e.newImgSrc),n.setAttribute("alt",e.newImgName),t.querySelector(e.elementNumberOfLikesSelector).textContent=e.likes,t.querySelector(e.elementPhotocardSelector).setAttribute("id",e.newId),e.trashFilter||t.querySelector(e.elementTrashSelector).remove(),e.liked&&t.querySelector(e.elementLikeSelector).classList.add(e.elementLikedByUserClass),t}function r(e,t){for(var n=0;n<e.length;n++)if(e[n]._id===t)return!0;return!1}var a,l,c,s,i,m,u,d,p,f,S,h,v,b,k,_,L,y,C,g,A,N,U,E,P,B,w,q,O,x,T,I,G,D,F,j,J={baseUrl:"https://nomoreparties.co/v1/wbf-cohort-4",headers:{authorization:"53974bf9-4dd2-454a-be24-3d74e4bf4738","Content-Type":"application/json"}};function H(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}function V(e){e.elementsGrid.addEventListener("click",(function(n){var o,r,a=n.target.classList;a.contains(e.trashClass)?(o=n.target.closest(e.elementFromGridSelector),(r=o.id,fetch("".concat(J.baseUrl,"/cards/").concat(r),{headers:J.headers,method:"DELETE"}).then(H)).then((function(){o.remove()})).catch((function(e){console.log("Ошибка удаления карточки. ".concat(e))}))):a.contains(e.elementPhotoClass)?function(e,n,o,r){o.textContent=e.target.closest(".element").querySelector(".element__name").textContent,r.setAttribute("src",e.target.getAttribute("src")),r.setAttribute("alt",e.target.getAttribute("alt")),t(n)}(n,e.popUpPhotocard,e.photocardName,e.photocardImg):a.contains(e.elementLikeClass)&&(n.preventD,function(e){var t,n=e.elementBox.querySelector(e.elementNumberOfLikesSelector);e.likeButton.classList.contains(e.elementLikedByUserClass)?(console.log(e.elementBox.id),(t=e.elementBox.id,fetch("".concat(J.baseUrl,"/cards/likes/").concat(t),{headers:J.headers,method:"DELETE"}).then(H)).then((function(t){e.likeButton.classList.remove(e.elementLikedByUserClass),n.textContent=t.likes.length})).catch((function(e){console.log("Ошибка удаления лайка. ".concat(e))}))):(console.log(e.elementBox.id),function(e){return fetch("".concat(J.baseUrl,"/cards/likes/").concat(e),{headers:J.headers,method:"PUT"}).then(H)}(e.elementBox.id).then((function(t){e.likeButton.classList.add(e.elementLikedByUserClass),n.textContent=t.likes.length})).catch((function(e){console.log("Ошибка лайка. ".concat(e))})))}({elementLikedByUserClass:e.elementLikedByUserClass,likeButton:n.target,elementNumberOfLikesSelector:e.elementNumberOfLikesSelector,elementBox:n.target.closest(e.elementFromGridSelector)}))})),function(e){fetch("".concat(J.baseUrl,"/cards"),{headers:J.headers}).then(H).then((function(t){t.forEach((function(t){e.elementsGrid.append(o({elementLikeSelector:".".concat(e.elementLikeClass),elementLikedByUserClass:e.elementLikedByUserClass,elementTrashSelector:e.elementTrashSelector,elementPhotocardSelector:e.elementPhotocardSelector,newImgName:t.name,newImgSrc:t.link,template:e.template,elementNameSelector:e.elementNameSelector,elementPhotoSelector:e.elementPhotoSelector,newId:t._id,elementNumberOfLikesSelector:e.elementNumberOfLikesSelector,likes:t.likes.length,liked:r(t.likes,e.myId),trashFilter:t.owner._id===e.myId}))}))})).catch((function(e){console.log("Ошибка получения карточек с сервера. ".concat(e))}))}({elementLikeClass:e.elementLikeClass,myId:e.myId,elementLikedByUserClass:e.elementLikedByUserClass,elementNumberOfLikesSelector:e.elementNumberOfLikesSelector,elementTrashSelector:e.elementTrashSelector,elementPhotocardSelector:e.elementPhotocardSelector,elementsGrid:e.elementsGrid,template:e.template,elementNameSelector:e.elementNameSelector,elementPhotoSelector:e.elementPhotoSelector})}function z(e,t){e.textContent=t}function M(e,t,n){!function(e){return e.some((function(e){return!e.validity.valid}))}(e)?(t.classList.remove(n),t.removeAttribute("disabled")):(t.classList.add(n),t.setAttribute("disabled","disabled"))}c=document.querySelector(".elements"),s=document.querySelector(".pop-up_container_photocard"),i=document.querySelector(".pop-up_container_edit"),m=document.querySelector(".pop-up_container_add"),u=document.querySelector(".pop-up_container_change-avatar"),d=document.querySelector("#template"),p=document.querySelector(".profile__avatar"),f=document.querySelector(".profile__edit-button"),S=document.querySelector(".profile__add-button"),h=document.querySelector(".profile__change-avatar-button"),v=document.querySelector(".profile__name"),b=document.querySelector(".profile__status"),k=s.querySelector(".pop-up__photocard-name"),_=s.querySelector(".pop-up__photocard-img"),y=(L=document.forms.edit).elements.inputName,C=L.elements.inputStatus,g=L.elements.save,A=document.forms.add,N=document.forms.add.elements,U=N.inputElementName,E=N.inputElementSrc,P=A.elements.save,w=(B=document.forms.avatar).elements.inputAvatarSrc,q=B.elements.save,O=".element",x=".element__trash",T=".element__name",I=".element__photo",G="element__like",D="element__like_liked",F=".element__number-of-likes",(j={currentAvatarSrc:p,profileName:v,profileStatus:b},fetch("".concat(J.baseUrl,"/users/me"),{headers:J.headers}).then(H).then((function(e){return j.currentAvatarSrc.setAttribute("src",e.avatar),j.profileName.textContent=e.name,j.profileStatus.textContent=e.about,Promise.resolve(e._id)})).catch((function(e){return console.log(e),Promise.reject("Неполучен Профиль пользователя (id). ".concat(e))}))).then((function(e){var r;V({elementLikedByUserClass:D,elementNumberOfLikesSelector:F,myId:e,elementTrashSelector:x,elementPhotocardSelector:O,elementsGrid:c,popUpPhotocard:s,elementNameSelector:T,elementPhotoSelector:I,photocardName:k,photocardImg:_,template:d,trashClass:"element__trash",elementFromGridSelector:".elements__child",elementPhotoClass:"element__photo",elementLikeClass:G}),(r={elementLikeClass:G,elementLikedByUserClass:D,buttonAddSave:P,elementNumberOfLikesSelector:F,elementTrashSelector:x,elementPhotocardSelector:O,formAdd:A,elementsGrid:c,popUp:m,buttonOpenAddPhotocard:S,formAddElements:N,imgNameAdd:U,imgSrcAdd:E,elementNameSelector:T,elementPhotoSelector:I,template:d}).formAdd.reset(),r.buttonOpenAddPhotocard.addEventListener("click",(function(){t(r.popUp)})),r.formAdd.addEventListener("submit",(function(e){e.preventDefault(),function(e){var t;z(e.buttonAddSave,"Сохранение..."),(t={name:e.formAddElements.inputElementName.value,link:e.formAddElements.inputElementSrc.value},fetch("".concat(J.baseUrl,"/cards"),{headers:J.headers,method:"POST",body:JSON.stringify({name:t.name,link:t.link})}).then(H)).then((function(t){e.elementsGrid.prepend(o({elementLikeSelector:e.elementLikeSelector,elementLikedByUserClass:e.elementLikedByUserClass,elementTrashSelector:e.elementTrashSelector,elementPhotocardSelector:e.elementPhotocardSelector,newImgName:t.name,newImgSrc:t.link,template:e.template,elementNameSelector:e.elementNameSelector,elementPhotoSelector:e.elementPhotoSelector,newId:t._id,elementNumberOfLikesSelector:e.elementNumberOfLikesSelector,likes:t.likes.length,liked:!1,trashFilter:!0})),n(e.popUp)})).catch((function(e){console.log("Ошибка создания карточки. ".concat(e))})).finally((function(){z(e.buttonAddSave,"Создать")}))}({elementLikeSelector:".".concat(r.elementLikeClass),elementLikedByUserClass:r.elementLikedByUserClass,elementNumberOfLikesSelector:r.elementNumberOfLikesSelector,buttonAddSave:r.buttonAddSave,elementTrashSelector:r.elementTrashSelector,elementPhotocardSelector:r.elementPhotocardSelector,elementsGrid:r.elementsGrid,formAddElements:r.formAddElements,popUp:r.popUp,template:r.template,elementNameSelector:r.elementNameSelector,elementPhotoSelector:r.elementPhotoSelector}),r.formAdd.reset()}))})).catch((function(e){console.log("".concat(e,",карточки отображаем только после получения Id, id неполучен, нельзя создать карточки"))})),a={popUpClass:"pop-up",popUpCloseButton:"pop-up__close-button"},document.querySelectorAll(".".concat(a.popUpClass)).forEach((function(e){e.addEventListener("click",(function(t){(t.target.classList.contains(a.popUpClass)||t.target.classList.contains(a.popUpCloseButton))&&n(e)}))})),function(e){e.buttonOpenEdit.addEventListener("click",(function(){!function(e){t(e.popUp),e.newName.value=e.profileName.textContent,e.newStatus.value=e.profileStatus.textContent}({popUp:e.popUpEdit,newName:e.newName,newStatus:e.newStatus,profileName:e.profileName,profileStatus:e.profileStatus})})),e.popUpEdit.addEventListener("submit",(function(t){t.preventDefault(),function(e){var t,o;z(e.buttonEditSave,"Сохранение..."),(t=e.newName.value,o=e.newStatus.value,fetch("".concat(J.baseUrl,"/users/me"),{method:"PATCH",headers:J.headers,body:JSON.stringify({name:t,about:o})}).then(H)).then((function(t){e.profileName.textContent=t.name,e.profileStatus.textContent=t.about,n(e.popUp)})).catch((function(e){console.log("Ошибка изменения профиля. ".concat(e))})).finally((function(){z(e.buttonEditSave,"Сохранить")}))}({buttonEditSave:e.buttonEditSave,popUp:e.popUpEdit,newName:e.newName,newStatus:e.newStatus,profileName:e.profileName,profileStatus:e.profileStatus})}))}({buttonEditSave:g,popUpEdit:i,formEdit:L,buttonOpenEdit:f,newName:y,newStatus:C,profileName:v,profileStatus:b}),function(e){e.formAvatarChange.reset(),e.buttonOpenAvatarChange.addEventListener("click",(function(){t(e.popUp)})),e.formAvatarChange.addEventListener("submit",(function(t){var o,r;t.preventDefault(),z((o={buttonAvatarChangeSave:e.buttonAvatarChangeSave,currentAvatarSrc:e.currentAvatarSrc,newAvatarSrcValue:e.newAvatarSrc.value,popUp:e.popUp}).buttonAvatarChangeSave,"Сохранение..."),(r=o.newAvatarSrcValue,fetch("".concat(J.baseUrl,"/users/me/avatar"),{headers:J.headers,method:"PATCH",body:JSON.stringify({avatar:r})}).then(H)).then((function(e){console.log(e),o.currentAvatarSrc.setAttribute("src",e.avatar),n(o.popUp)})).catch((function(e){console.log("Ошибка изменения аватара. ".concat(e))})).finally((function(){z(o.buttonAvatarChangeSave,"Сохранить")})),e.formAvatarChange.reset()}))}({buttonAvatarChangeSave:q,formAvatarChange:B,popUp:u,buttonOpenAvatarChange:h,newAvatarSrc:w,currentAvatarSrc:p}),l={formSelector:".form",inputSelector:".form__input",submitButtonSelector:".form__save-button-box",inactiveButtonClass:"form__save-button-box_inactive",inputErrorClass:"form__input_error",errorClass:"form__input-error-message_active"},Array.from(document.querySelectorAll(l.formSelector)).forEach((function(e){var t=Array.from(e.querySelectorAll(l.inputSelector)),n=e.querySelector(l.submitButtonSelector);M(t,n,l.inactiveButtonClass),e.addEventListener("reset",(function(){setTimeout((function(){M(t,n,l.inactiveButtonClass)}),0)})),t.forEach((function(o){o.addEventListener("input",(function(){!function(e,t,n,o){t.validity.valid?function(e,t,n,o){var r=e.querySelector(".form__input-error-message_type_".concat(t.id));t.classList.remove(n),r.classList.remove(o),r.textContent=""}(e,t,n,o):function(e,t,n,o,r){var a=e.querySelector(".form__input-error-message_type_".concat(t.id));t.classList.add(o),a.textContent=n,a.classList.add(r)}(e,t,t.validationMessage,n,o)}(e,o,l.inputErrorClass,l.errorClass),M(t,n,l.inactiveButtonClass)}))}))}))})();